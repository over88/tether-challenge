name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses:  actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check linear history
        uses: over88/reusable-cicd-actions/.github/actions/check-linear-history@main

      - name:  Check branch is up-to-date
        uses: over88/reusable-cicd-actions/.github/actions/check-branch-updated@main
        with:
          base-branch: main

      - name: Setup Node. js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check lockfile exists
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo ":: error::package-lock.json is required"
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Unit Tests
        run: npm test

      - name: Check version bump
        if: contains(github.event.pull_request.labels.*.name, 'publish')
        uses: over88/reusable-cicd-actions/.github/actions/check-version-bump@main
        with:
          base-ref: ${{ github.event.pull_request.base.sha }}

  integration-tests:
    name: Integration/E2E Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'verify')
    needs: validate

    steps:
      - name: Checkout code
        uses:  actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run E2E tests
        run: npm run e2e

  build-release-candidate:
    name: Build Release Candidate
    runs-on:  ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'publish')
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get version from package.json
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Check if version exists on npm
        run: |
          VERSION="${{ steps.package-version.outputs.version }}"
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          
          if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null; then
            echo ":: error::Version $VERSION already exists on npm"
            exit 1
          fi

      - name: Create dev version
        id: dev-version
        run:  |
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="${{ steps.package-version. outputs.version }}"
          DEV_VERSION="${VERSION}-dev-${SHORT_SHA}"
          echo "dev-version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          
          # Temporarily update version for artifact
          npm version $DEV_VERSION --no-git-tag-version

      - name: Build
        run: npm run build

      - name: Create tarball
        run: npm pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name:  release-candidate
          path: "*.tgz"
          retention-days: 30

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script:  |
            github.rest.issues.createComment({
              issue_number: context. issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Release candidate built successfully!\n\n**Version:** \`${{ steps.dev-version.outputs.dev-version }}\`\n**Artifact:** Available in workflow artifacts`
            })